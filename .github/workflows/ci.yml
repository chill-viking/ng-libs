on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed]

name: CI

permissions:
  contents: read
  pull-requests: write

jobs:
  cache-deps:
    runs-on: ubuntu-latest
    name: Install Dependencies
    steps:
      - uses: actions/checkout@v3

      - uses: chill-viking/npm-ci@v1
        name: Install dependencies w/ caching

  nx-affected:
    uses: chill-viking/workflows/.github/workflows/nx-test-affected.yml@main
    name: Test affected
    if: github.event.action != 'closed'
    needs: cache-deps

  publish-to-sonar-cloud:
    uses: chill-viking/workflows/.github/workflows/nx-sonar-cloud-all.yml@main
    name: Coverage Report
    if: github.event.action != 'closed'
    needs: cache-deps
    secrets:
      sonar-token: ${{ secrets.ORG_SONAR_TOKEN }}
      github-token: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    uses: chill-viking/workflows/.github/workflows/swa-deploy.yml@main
    name: SWA
    needs: cache-deps
    if: always()
    with:
      output_location: dist/apps/chill-viking-ng-libs
    secrets:
      swa_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ASHY_FLOWER_0950BD703 }}
      git_token: ${{ secrets.GITHUB_TOKEN }}
